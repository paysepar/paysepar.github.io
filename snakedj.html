<!DOCTYPE HTML>
<head>
<meta name="description" content="Can a snake be a DJ? Yes!">
<meta name="author" content="Payam Paysepar">
<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
<style>
* { margin: 0; padding: 0;}

body, html { height:100%; }

#canvas {
    position:absolute;
    width:100%;
    height:100%;
    border: 5px solid blue;
    box-sizing: border-box;
}
</style>
</head>
<body>
<canvas id="canvas">
</canvas>
<!--
<audio src="drums/kick-classic.mp3" preload="auto" id="leanBass"/>
<audio src="drums/hihat-808.mp3" preload="auto" id="leanChords"/>
<audio src="drums/snare-sumo.mp3" preload="auto" id="leanDrums"/>
<audio src="drums/clap_017.mp3" preload="auto" id="leanPad"/>
<audio src="drums/tambourine_027.mp3" preload="auto" id="leanSynth"/>
-->
<audio src="drums/kick-heavy.wav" preload="auto" id="leanBass"/>
<audio src="drums/hihat-electro.wav" preload="auto" id="leanChords"/>
<audio src="drums/snare-tape.wav" preload="auto" id="leanDrums"/>
<audio src="drums/clap-808.wav" preload="auto" id="leanPad"/>
<audio src="drums/tom-fm.wav" preload="auto" id="leanSynth"/>

<script>

// JavaScript object bindings of HTML elements
var canvas = document.getElementById("canvas");
var context = canvas.getContext("2d");
var leanOnStems = [document.getElementById("leanBass"),
                   document.getElementById("leanChords"),
                   document.getElementById("leanDrums"),
                   document.getElementById("leanPad"),
                   document.getElementById("leanSynth"),
                   document.getElementById("leanVocal")];
    
// Canvas sizing is set to parent dimensions
canvas.height = canvas.parentElement.clientHeight;
canvas.width = canvas.parentElement.clientWidth;
    
// Snake width is equal to 1/15th of page width
var snkwidth = Math.floor(canvas.width / 15);

// Resize canvas so dimensions are multiple of snake width
canvas.width = Math.floor(canvas.width / snkwidth) * snkwidth;
canvas.height = Math.floor(canvas.height / snkwidth) * snkwidth;
    
// Height of canvas in snake widths
var nrSnakesY = Math.floor(canvas.height / snkwidth);

// Canvas dimensions
var cWidth = canvas.width;
var cHeight = canvas.height;
    
// 2 pi
var twopi = Math.PI * 2;

// Snake object
var snk = {};
// Snake orientation, direction of the snake's next movement. 0 is right, 1 is up, 2 is left, 3 is down.
snk.orient = 0;
// Snake's last orientation, direction of the snake's last movement
snk.lastorient = 0;
// Snake width
snk.width = snkwidth;
// Snake 1/2 width
snk.halfwidth = Math.floor(snk.width/2);
// Snake starting speed (ms between movements)
snk.startingSpeed = 800;
// Percent change in time between snake movements for every fruit eaten
snk.speedBoost = 0.92;
// Number of ms between snake movements
snk.speed = snk.startingSpeed;
// Number of food eaten
snk.nrEaten = 0;
// Number of beats in music the loop. Also number of segments of snake.
snk.nrBeats = 8;
// Array of arrays of sounds. First dimension is beat number, second dimension is the sounds.
snk.sounds = [];
// Reset snake sounds
snk.soundReset = function() {
    for (var i = 0; i < snk.nrBeats; i++)
    {
        snk.sounds[i] = [];
    }
};
snk.soundReset();
// Snake coordinates, stores positions of corners of the snake on canvas.
snk.coord = [];
// Set snake coordinates to initial values and set orientation to 0.
snk.coordSet = function() {
    this.coord = [[snk.halfwidth + snkwidth*(snk.nrBeats-1), Math.floor(snk.width*5.5)], [snk.halfwidth, Math.floor(snk.width*5.5)]];
    // Orient snake to the right
    snk.orient = 0;
    snk.lastorient = 0;
}
snk.coordSet();
// Current beat that is being played, beat indices start at 0
snk.beatNow = 0;
// Distances along snake from head of snake of segments of snake corresponding to beats
snk.beatDist = [];
for (var i = 0; i < snk.nrBeats; i++)
{
    snk.beatDist[i] = i * snk.width
}

// Change direction of snake movement by changing snk.orient according to key presses
var changeDirection = function(e) {
    console.log(e.keyCode);
    switch(e.keyCode)
    {
        case 37:
        case 65:
            if (snk.lastorient === 1 || snk.lastorient === 3)
                {
                    snk.orient = 2;
                }
            else if (snk.lastorient == 2)
                {
                    context.clearRect(0, 0, cWidth, cHeight);
                    drawFood();
                    snk.move();
                    snk.draw();
                }
            break;
        case 38:
        case 87:
            if (snk.lastorient === 0 || snk.lastorient === 2)
                {
                    snk.orient = 1;
                }
            else if (snk.lastorient == 1)
                {
                    context.clearRect(0, 0, cWidth, cHeight);
                    drawFood();
                    snk.move();
                    snk.draw();
                }
            break;
        case 68:
        case 39:
            if (snk.lastorient === 1 || snk.lastorient === 3)
                {
                    snk.orient = 0;
                }
            else if (snk.lastorient == 0)
                {
                    context.clearRect(0, 0, cWidth, cHeight);
                    drawFood();
                    snk.move();
                    snk.draw();
                }
            break;
        case 40:
        case 83:
            if (snk.lastorient === 0 || snk.lastorient === 2)
                {
                    snk.orient = 3;
                }
            else if (snk.lastorient == 3)
                {
                    context.clearRect(0, 0, cWidth, cHeight);
                    drawFood();
                    snk.move();
                    snk.draw();
                }
            break;
    }
};

// Change direction of snake movement by changing snk.orient according to positions of touches & clicks relative to head of snake
var changeDirection1 = function(e) {
    var xTouch = e.offsetX;
    var yTouch = e.offsetY;
    var xDiff = xTouch - snk.coord[0][0];
    var yDiff = yTouch - snk.coord[0][1];
    if (Math.abs(xDiff) > Math.abs(yDiff))
        {
            if (xDiff > 0 && snk.lastorient !== 0 && snk.lastorient !== 2)
            {
                snk.orient = 0;
                window.navigator.vibrate(20);
            }
            else if (xDiff < 0 && snk.lastorient !== 0 && snk.lastorient !== 2)
            {
                snk.orient = 2;
                window.navigator.vibrate(20);
            }
            else if (xDiff > 0 && snk.lastorient === 0)
            {
                context.clearRect(0, 0, cWidth, cHeight);
                drawFood();
                snk.move();
                snk.draw();
                window.navigator.vibrate(20);
            }
            else if (xDiff < 0 && snk.lastorient === 2)
            {
                context.clearRect(0, 0, cWidth, cHeight);
                drawFood();
                snk.move();
                snk.draw();
                window.navigator.vibrate(20);
            }
        }
    else
        {
            if (yDiff > 0 && snk.lastorient !== 3 && snk.lastorient !== 1)
            {
                snk.orient = 3;
                window.navigator.vibrate(20);
            }
            else if (yDiff < 0 && snk.lastorient !== 3 && snk.lastorient !== 1)
            {
                snk.orient = 1;
                window.navigator.vibrate(20);
            }
            else if (yDiff > 0 && snk.lastorient === 3)
            {
                context.clearRect(0, 0, cWidth, cHeight);
                drawFood();
                snk.move();
                snk.draw();
                window.navigator.vibrate(20);
            }
            else if (yDiff < 0 && snk.lastorient === 1)
            {
                context.clearRect(0, 0, cWidth, cHeight);
                drawFood();
                snk.move();
                snk.draw();
                window.navigator.vibrate(20);
            }
        }
}

    
// Move snake in proper direction
snk.move = function() {
    // Move the first snake coordinate according to orientation
    switch (this.orient)
    {
        case 0:
            if (this.lastorient !== 0)
                {
                    this.coord.splice(1, 0, this.coord[0].slice(0));
                }
            this.coord[0][0] = this.coord[0][0] + this.width;
            this.lastorient = 0;
            this.checkCollision();
            break;
        case 1:
            if (this.lastorient !== 1)
                {
                    this.coord.splice(1, 0, this.coord[0].slice(0));
                }
            this.coord[0][1] = this.coord[0][1] - this.width;
            this.lastorient = 1;
            this.checkCollision();
            break;
        case 2:
            if (this.lastorient !== 2)
                {
                    this.coord.splice(1, 0, this.coord[0].slice(0));
                }
            this.coord[0][0] = this.coord[0][0] - this.width;
            this.lastorient = 2;
            this.checkCollision();
            break;
        case 3:
            if (this.lastorient !== 3)
                {
                    this.coord.splice(1, 0, this.coord[0].slice(0));
                }
            this.coord[0][1] = this.coord[0][1] + this.width;
            this.lastorient = 3;
            this.checkCollision();
            break;
        default:
            console.log("snk.orient is not set")
            this.lastorient = 0;
            this.checkCollision();
            this.coord[0][0] = this.coord[0][0] + this.width;
            break;
    }
    // Move last snake coordinate in direction of second to last coordinate
    // First get difference in x and y of 2nd to last and last coords
    var diffX = this.coord[this.coord.length - 2][0] - this.coord[this.coord.length - 1][0];
    var diffY = this.coord[this.coord.length - 2][1] - this.coord[this.coord.length - 1][1];
    // Change last snake coord accordingly
    if (diffX != 0)
        {
            diffX = diffX/Math.abs(diffX);
            this.coord[this.coord.length - 1][0] = this.coord[this.coord.length - 1][0] + (diffX * this.width);
        }
    if (diffY != 0)
        {
            diffY = diffY/Math.abs(diffY);
            this.coord[this.coord.length - 1][1] = this.coord[this.coord.length - 1][1] + (diffY * this.width);
        }
    // If last snake coordinate is now equal to second to last, then push last off
    if (this.coord[this.coord.length - 1][0] === this.coord[this.coord.length - 2][0] && this.coord[this.coord.length - 1][1] === this.coord[this.coord.length - 2][1])
        {
            this.coord.splice(this.coord.length - 1, 1);
        }
};

snk.checkCollision = function() {
    // Check for collision with walls
    if (this.coord[0][0] > cWidth || this.coord[0][1] > cHeight || this.coord[0][0] < 0 || this.coord[0][1] < 0)
        {
            gameOver();
        }
    if (this.coord[0][0] == food[0][0] && this.coord[0][1] == food[0][1])
        {
            this.eatFood(food[0]);
        }
    for (var i = 3; i < this.coord.length; i++)
    {
        var x0 = this.coord[i-1][0];
        var x1 = this.coord[i][0];
        var y0 = this.coord[i-1][1];
        var y1 = this.coord[i][1];
        // make x1 larger than x0
        if (x0 > x1)
        {
            var temp = x1;
            x1 = x0;
            x0 = temp;
        }
        if (y0 > y1)
        {
            var temp = y1;
            y1 = y0;
            y0 = temp;
        }
        if (x0 === x1 && x0 === this.coord[0][0] && this.coord[0][1] <= y1 && this.coord[0][1] >= y0)
        {
            gameOver();
        }
        else if (y0 === y1 && y0 === this.coord[0][1] && this.coord[0][0] <= x1 && this.coord[0][0] >= x0)
        {
            gameOver();
        }
    }
}


// changes location of food whenever snake eats it
// adds a sound and 1 snake segment and speed boost for every 4th food eaten
snk.eatFood = function(food) {
    food[0] = this.width * Math.floor(13.9*Math.random()) + Math.floor(this.width/2);
    food[1] = this.width * Math.floor((nrSnakesY-1)*Math.random()) + Math.floor(this.width/2);
    this.nrEaten++;
    if (this.nrEaten % 4 === 0)
        {
            var newSound = leanOnStems[this.nrEaten % 5];
            this.sounds[this.beatNow].push(newSound);
            this.speed = Math.floor(this.speed * this.speedBoost);
            // enlarge snake by 1 segment
            var xlast = this.coord[this.coord.length-1][0];
            var ylast = this.coord[this.coord.length-1][1];
            var xntlast = this.coord[this.coord.length-2][0];
            var yntlast = this.coord[this.coord.length-2][1];
            if (xlast > xntlast)
            {
                console.log(xlast);
                this.coord[this.coord.length-1][0] += this.width;
                console.log(this.coord[this.coord.length-1][0]);
            }
            else if (xntlast > xlast)
            {
                console.log(xlast);
                this.coord[this.coord.length-1][0] -= this.width;
                console.log(this.coord[this.coord.length-1][0]);
            }
            else if (ylast > yntlast)
            {
                this.coord[this.coord.length-1][1] -= this.width;
            }
            else if (yntlast > ylast)
            {
                this.coord[this.coord.length-1][0] += this.width;
            }
        }
}

snk.playSounds = function() {
    for (var i = 0; i < this.sounds[this.beatNow].length; i++)
        {
            this.sounds[this.beatNow][i].currentTime = 0;
            this.sounds[this.beatNow][i].play();
        }
    this.beatNow = (this.beatNow + 1) % 8;
}

snk.drawScore = function() {
    context.font = "30px Comic Sans MS";
    context.fillStyle = "#ff0000";
    context.textAlign = "right";
    context.fillText(this.nrEaten.toString(), cWidth - 50, cHeight - 50);
}

// Draws snake on canvas
snk.draw = function() {
    context.lineWidth = snk.width;
    context.beginPath();
    context.strokeStyle = "#000000";
    context.lineCap = "square";
    context.moveTo(this.coord[0][0], this.coord[0][1]);
    var segNo = 0;
    var beatNotDrawn = true;
    for (var i = 1; i < snk.coord.length; i++)
    {
        context.lineTo(this.coord[i][0], this.coord[i][1]);
    }
    context.stroke();
};
    
// Food array. Stores food objects.
var food = [[Math.floor(snk.width*2.5), Math.floor(snk.width*4.5), 1]];
    
// System time
var t0 = 0;
var t1;
    
// Main drawing loop. Clears canvas and draws.
function draw() {
    t1 = performance.now();
    if (t1 - t0 > snk.speed) {
        context.clearRect(0, 0, cWidth, cHeight);
        snk.move();
        snk.draw();
        drawFood();
        snk.drawScore();
        snk.playSounds();
        t0 = performance.now();
    }
    window.requestAnimationFrame(draw);
};
    
// Initiate main drawing loop
draw();

// End current game if snake collides
function gameOver() {
    // Place snake in starting position and orientation
    snk.coordSet();
    // Reset nrEaten to 0
    snk.nrEaten = 0;
    // Reset speed to initial
    snk.speed = snk.startingSpeed;
    // Reset sounds
    snk.soundReset();
}


// Draws food on canvas
function drawFood() {
    for (var i = 0; i < food.length; i++)
        {
            context.beginPath();
            if ((snk.nrEaten + 1) % 4 === 0)
            {
                context.fillStyle = "#ff0000"
            }
            else
            {
                context.fillStyle = "#000000"
            }
            context.arc(food[i][0], food[i][1], Math.floor(snk.halfwidth), 0, twopi);
            context.fill();
        }
}
    
// Event listeners
window.addEventListener("keydown", changeDirection);
canvas.addEventListener("touchstart", changeDirection1);
canvas.addEventListener("mousedown", changeDirection1);


</script>
</body>
